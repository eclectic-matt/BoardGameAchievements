<!DOCTYPE html>
<html>

  <head>

    <script>

      var inputUser, divResults;
      var collectionsXML, playsXML;
      var userData = {};

      var achievements = {};
      achievements.list = ["collector", "player"];
      //achievements.collector[i] = [Level, "Prefix", ownedCount];
      achievements.collector = [];
      achievements.collector[0] = [1, "Basic", 5];
      achievements.collector[1] = [2, "Keen", 100];
      achievements.collector[2] = [3, "Avid", 500];
      achievements.collector[3] = [4, "Obsessive", 5000];
      achievements.collector[4] = [5, "Legendary", 25000];
      //achievements.player[i] = [Level, "Prefix", playCount];
      achievements.player = [];
      achievements.player[0] = [1, "Basic", 5];
      achievements.player[1] = [2, "Keen", 100];
      achievements.player[2] = [3, "Avid", 500];
      achievements.player[3] = [4, "Obsessive", 5000];
      achievements.player[4] = [5, "Legendary", 25000];

      function startup(){
        var getUsername = '';
        inputUser = document.getElementById('inputBGGuser');
        divResults = document.getElementById('divResults');
        //inputUser.addEventListener('onUpdate', sanitizeAndCheck() );
        console.log('Started...');
      }

      function sanitizeAndCheck(){

        userData.name = '';
        userData.plays = 0;
        userData.owned = 0;
        userData.achievements = {};

        let getUsername = inputUser.value;
        // THEN SANITIZE THIS NAME FOR SPECIAL CHARS
        divResults.innerHTML = getUsername;
        console.log('Getting results for ',getUsername);
        getAchievements(getUsername);

      }

      function getAchievements(user){

        // XHTTP request to collections
        let urlCollections = "https://api.geekdo.com/xmlapi2/collection?username=" + user;

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
               // Typical action to be performed when the document is ready:
               let collectionsResponse = xhttp.responseText;
               parseCollections(collectionsResponse);
               //document.getElementById("divResults").innerHTML = xhttp.responseText;
            }
        };
        xhttp.open("GET", urlCollections, true);
        xhttp.send();

        // XHTTP request to plays
        let urlPlays = "https://api.geekdo.com/xmlapi2/plays?username=" + user;

        var xhttp2 = new XMLHttpRequest();
        xhttp2.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
               // Typical action to be performed when the document is ready:
               let playsResponse = xhttp2.responseText;
               parsePlays(playsResponse);
               //document.getElementById("divResults").innerHTML = xhttp.responseText;
            }
        };
        xhttp2.open("GET", urlPlays, true);
        xhttp2.send();



      }

      function updateResults(){
        divResults.innerHTML = "Total Owned Games: " + userData.owned;
        divResults.innerHTML += "<br>Total Logged Plays: " + userData.plays;
        //divResults.innerHTML += "<br>PLAYER MEDAL: " + userData.plays;
      }

      function parsePlays(resp){
        //console.log(resp);
        var currentResults = divResults.innerHTML;

        // Declare a DOM/XML parser
        var parser = new DOMParser();
        // Then parse the resp string as XML
        var playsXML = parser.parseFromString(resp, 'text/xml');

        // The details are contained within "status"
        let playsSummary = playsXML.getElementsByTagName("plays")[0].attributes;
        let playTotal = playsSummary.getNamedItem("total").nodeValue;
        console.log('Total Plays Logged: ', playTotal);
        userData.plays = playTotal;

        // Get the hard-coded achievements data for the "player" achievement
        aPlays = achievements.player;
        // Assign the earned medal -1 (not achieved)
        playsMedal = -1;

        // Loop through the achievement requirements
        for (i = 0; i < aPlays.length; i++){

          // If you have logged at least the required number
          if (playTotal >= aPlays[i][2]){

            // Assign this medal to playsMedal
            playsMedal = i;
            //console.log('Achieved ' + aPlays[i][1] + ' Player Achievement with at least ' + aPlays[i][2] + ' plays logged!');

          }

        }

        console.log('The final player achievement is Level ' + playsMedal);
        updateResults();

      }

      function parseCollections(resp){

        // Declare a DOM/XML parser
        var parser = new DOMParser();
        // Then parse the resp string as XML
        var collectionsXML = parser.parseFromString(resp, 'text/xml');
        // The item array is pulled by tag name
        var itemArr = collectionsXML.getElementsByTagName("item");
        // The initial own count
        var ownCount = 0;
        // Variables within the loop, holding the item being checked
        var item, details, status;

        console.log("Getting owned games list...");
        //divResults.innerHTML = "Getting owned games list...";

        for (i = 1; i < itemArr.length; i++){

          // Each item is contained within itemArr
          let item = itemArr[i];
          // The details are contained within "status"
          let details = item.getElementsByTagName("status")[0].attributes;
          // Then the key status - owned - is captured here "0" or "1"
          let status = details.getNamedItem("own").nodeValue;

          // If the status is not "0" then add to owned list
          if (status !== "0"){

            //console.log(item.childNodes[1].childNodes[0]);
            ownCount++;

          }

        }

        console.log('Total Games Owned: ',ownCount);
        userData.owned = ownCount;

        // Get the hard-coded achievements data for the "player" achievement
        aOwner = achievements.collector;
        // Assign the earned medal -1 (not achieved)
        ownerMedal = -1;

        // Loop through the achievement requirements
        for (i = 0; i < aOwner.length; i++){

          // If you have logged at least the required number
          if (ownCount >= aOwner[i][2]){

            // Assign this medal to playsMedal
            ownerMedal = i;
            //console.log('Achieved ' + aOwner[i][1] + ' Collector Achievement with at least ' + aOwner[i][2] + ' games owned!');

          }

        }

        console.log('The final collector achievement is Level ' + ownerMedal);

        updateResults();
        //divResults.innerHTML = 'Total Owned: ' + ownCount;

      }

    </script>

  </head>
  <body onload='startup()'>
    <h1>Board Game Achievements</h1>

    <p>Please enter your BGG username: <input type='text' id='inputBGGuser' placeholder='Your Username' value='EclecticMatt'></input></p>

    <button onclick='sanitizeAndCheck()'>Get Achievements</button>

    <div id='divResults'></div>

  </body>

</html>
