<!DOCTYPE html>
<html>

  <head>

    <script>

      var inputUser, divResults;
      var collectionsXML, playsXML;

      function startup(){
        var getUsername = '';
        inputUser = document.getElementById('inputBGGuser');
        divResults = document.getElementById('divResults');
        //inputUser.addEventListener('onUpdate', sanitizeAndCheck() );
        console.log('Started...');
      }

      function sanitizeAndCheck(){

        let getUsername = inputUser.value;
        // THEN SANITIZE THIS NAME FOR SPECIAL CHARS
        divResults.innerHTML = getUsername;
        console.log(getUsername);
        getAchievements(getUsername);

      }

      function getAchievements(user){

        // XHTTP request to collections
        let urlCollections = "https://api.geekdo.com/xmlapi2/collection?username=" + user;

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
               // Typical action to be performed when the document is ready:
               let collectionsResponse = xhttp.responseText;
               parseCollections(collectionsResponse);
               //document.getElementById("divResults").innerHTML = xhttp.responseText;
            }
        };
        xhttp.open("GET", urlCollections, true);
        xhttp.send();

        // XHTTP request to plays
        let urlPlays = "https://api.geekdo.com/xmlapi2/plays?username=" + user;

        var xhttp2 = new XMLHttpRequest();
        xhttp2.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
               // Typical action to be performed when the document is ready:
               let playsResponse = xhttp2.responseText;
               parsePlays(playsResponse);
               //document.getElementById("divResults").innerHTML = xhttp.responseText;
            }
        };
        xhttp2.open("GET", urlPlays, true);
        xhttp2.send();



      }

      function parsePlays(resp){
        console.log(resp);
      }

      function parseCollections(resp){

        // Declare a DOM/XML parser
        var parser = new DOMParser();
        // Then parse the resp string as XML
        var collectionsXML = parser.parseFromString(resp, 'text/xml');
        // The item array is pulled by tag name
        var itemArr = collectionsXML.getElementsByTagName("item");
        // The initial own count
        var ownCount = 0;
        // Variables within the loop, holding the item being checked
        var item, details, status;

        console.log("Getting owned games list...");
        divResults.innerHTML = "Getting owned games list...";

        for (i = 1; i < itemArr.length; i++){

          // Each item is contained within itemArr
          let item = itemArr[i];
          // The details are contained within "status"
          let details = item.getElementsByTagName("status")[0].attributes;
          // Then the key status - owned - is captured here "0" or "1"
          let status = details.getNamedItem("own").nodeValue;

          // If the status is not "0" then add to owned list
          if (status !== "0"){

            console.log(item.childNodes[1].childNodes[0]);
            ownCount++;

          }

        }

        console.log('Total Owned: ',ownCount);
        divResults.innerHTML = 'Total Owned: ' + ownCount;

      }

    </script>

  </head>
  <body onload='startup()'>
    <h1>Board Game Achievements</h1>

    <p>Please enter your BGG username: <input type='text' id='inputBGGuser' placeholder='Your Username' value='EclecticMatt'></input></p>

    <button onclick='sanitizeAndCheck()'>Get Achievements</button>

    <div id='divResults'></div>

  </body>

</html>
